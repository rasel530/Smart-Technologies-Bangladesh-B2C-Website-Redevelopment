{"version":3,"names":["sessionService","require","loggerService","SessionMiddleware","constructor","logger","authenticate","options","req","res","next","sessionId","getSessionId","handleNoSession","validation","validateSession","valid","handleInvalidSession","reason","session","userId","logAuth","ip","userAgent","get","path","originalUrl","error","message","status","json","timestamp","Date","toISOString","optional","warn","required","requireFresh","maxAge","sessionAge","now","createdAt","getTime","handleStaleSession","requireSecurityLevel","minLevel","sessionSecurityLevel","securityLevel","securityLevels","sessionLevelIndex","indexOf","requiredLevelIndex","requiredLevel","currentLevel","authHeader","headers","authorization","startsWith","substring","sessionHeader","cookies","rememberMe","info","rememberMeCookie","query","session_id","isApiRequest","xhr","accept","includes","code","loginUrl","returnUrl","encodeURIComponent","redirect","logSecurity","rateLimit","config","windowMs","max","key","windowStart","trackActivity","on","refreshSession","extendSession","cleanup","originalEnd","end","data","destroySession","call","sessionHeaders","expiresAt","toString","setSessionCookie","cookieOptions","httpOnly","secure","process","env","NODE_ENV","sameSite","cookie","rememberMeOptions","rememberMeId","createHash","update","digest","clearCookie","clearSessionCookie","sessionMiddleware","module","exports"],"sources":["session.js"],"sourcesContent":["const { sessionService } = require('../services/sessionService');\r\nconst { loggerService } = require('../services/logger');\r\n\r\nclass SessionMiddleware {\r\n  constructor() {\r\n    this.sessionService = sessionService;\r\n    this.logger = loggerService;\r\n  }\r\n\r\n  // Main session authentication middleware\r\n  authenticate(options = {}) {\r\n    return async (req, res, next) => {\r\n      try {\r\n        // Get session ID from header or cookie\r\n        const sessionId = this.getSessionId(req);\r\n        \r\n        if (!sessionId) {\r\n          return this.handleNoSession(req, res, options);\r\n        }\r\n\r\n        // Validate session\r\n        const validation = await this.sessionService.validateSession(sessionId, req);\r\n        \r\n        if (!validation.valid) {\r\n          return this.handleInvalidSession(req, res, validation.reason, options);\r\n        }\r\n\r\n        // Attach session data to request\r\n        req.session = validation.session;\r\n        req.sessionId = sessionId;\r\n        req.userId = validation.session.userId;\r\n\r\n        // Log successful session validation\r\n        this.logger.logAuth('Session Validated', validation.session.userId, {\r\n          sessionId,\r\n          ip: req.ip,\r\n          userAgent: req.get('User-Agent'),\r\n          path: req.originalUrl\r\n        });\r\n\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Session middleware error', error.message, {\r\n          ip: req.ip,\r\n          path: req.originalUrl\r\n        });\r\n\r\n        return res.status(500).json({\r\n          error: 'Session validation failed',\r\n          message: 'Unable to validate session at this time',\r\n          timestamp: new Date().toISOString()\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  // Optional session authentication (guest access allowed)\r\n  optional(options = {}) {\r\n    return async (req, res, next) => {\r\n      try {\r\n        const sessionId = this.getSessionId(req);\r\n        \r\n        if (!sessionId) {\r\n          // No session provided, continue as guest\r\n          req.session = null;\r\n          req.sessionId = null;\r\n          req.userId = null;\r\n          return next();\r\n        }\r\n\r\n        // Try to validate session\r\n        const validation = await this.sessionService.validateSession(sessionId, req);\r\n        \r\n        if (validation.valid) {\r\n          req.session = validation.session;\r\n          req.sessionId = sessionId;\r\n          req.userId = validation.session.userId;\r\n        } else {\r\n          // Invalid session, continue as guest\r\n          req.session = null;\r\n          req.sessionId = null;\r\n          req.userId = null;\r\n          \r\n          this.logger.warn('Invalid optional session', validation.reason, {\r\n            sessionId,\r\n            ip: req.ip,\r\n            userAgent: req.get('User-Agent')\r\n          });\r\n        }\r\n\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Optional session middleware error', error.message);\r\n        \r\n        // Continue as guest on error\r\n        req.session = null;\r\n        req.sessionId = null;\r\n        req.userId = null;\r\n        next();\r\n      }\r\n    };\r\n  }\r\n\r\n  // Require valid session (no guest access)\r\n  required(options = {}) {\r\n    return this.authenticate(options);\r\n  }\r\n\r\n  // Session must be fresh (no old sessions)\r\n  requireFresh(options = {}) {\r\n    return async (req, res, next) => {\r\n      const sessionId = this.getSessionId(req);\r\n      \r\n      if (!sessionId) {\r\n        return this.handleNoSession(req, res, options);\r\n      }\r\n\r\n      const validation = await this.sessionService.validateSession(sessionId, req);\r\n      \r\n      if (!validation.valid) {\r\n        return this.handleInvalidSession(req, res, validation.reason, options);\r\n      }\r\n\r\n      // Check if session is fresh (created within specified time)\r\n      const maxAge = options.maxAge || 30 * 60 * 1000; // 30 minutes default\r\n      const sessionAge = Date.now() - validation.session.createdAt.getTime();\r\n      \r\n      if (sessionAge > maxAge) {\r\n        return this.handleStaleSession(req, res, validation.session, options);\r\n      }\r\n\r\n      // Attach session data\r\n      req.session = validation.session;\r\n      req.sessionId = sessionId;\r\n      req.userId = validation.session.userId;\r\n\r\n      next();\r\n    };\r\n  }\r\n\r\n  // Session with specific security level\r\n  requireSecurityLevel(minLevel = 'standard') {\r\n    return async (req, res, next) => {\r\n      const sessionId = this.getSessionId(req);\r\n      \r\n      if (!sessionId) {\r\n        return this.handleNoSession(req, res);\r\n      }\r\n\r\n      const validation = await this.sessionService.validateSession(sessionId, req);\r\n      \r\n      if (!validation.valid) {\r\n        return this.handleInvalidSession(req, res, validation.reason);\r\n      }\r\n\r\n      // Check security level\r\n      const sessionSecurityLevel = validation.session.securityLevel || 'standard';\r\n      const securityLevels = ['low', 'standard', 'high'];\r\n      const sessionLevelIndex = securityLevels.indexOf(sessionSecurityLevel);\r\n      const requiredLevelIndex = securityLevels.indexOf(minLevel);\r\n      \r\n      if (sessionLevelIndex < requiredLevelIndex) {\r\n        return res.status(403).json({\r\n          error: 'Insufficient security level',\r\n          message: 'This action requires a higher security level session',\r\n          requiredLevel: minLevel,\r\n          currentLevel: sessionSecurityLevel\r\n        });\r\n      }\r\n\r\n      // Attach session data\r\n      req.session = validation.session;\r\n      req.sessionId = sessionId;\r\n      req.userId = validation.session.userId;\r\n\r\n      next();\r\n    };\r\n  }\r\n\r\n  // Get session ID from various sources\r\n  getSessionId(req) {\r\n    // Try Authorization header first (Bearer token)\r\n    const authHeader = req.headers.authorization;\r\n    if (authHeader && authHeader.startsWith('Bearer ')) {\r\n      return authHeader.substring(7);\r\n    }\r\n\r\n    // Try X-Session-ID header\r\n    const sessionHeader = req.headers['x-session-id'];\r\n    if (sessionHeader) {\r\n      return sessionHeader;\r\n    }\r\n\r\n    // Try cookies\r\n    if (req.cookies && req.cookies.sessionId) {\r\n      return req.cookies.sessionId;\r\n    }\r\n\r\n    // Try remember me cookie validation for auto-login\r\n    if (req.cookies && req.cookies.rememberMe && !req.cookies.sessionId) {\r\n      // This would need to be implemented with remember me token validation\r\n      // For now, return null to force fresh login\r\n      this.logger.info('Remember me cookie detected but no session ID', {\r\n        rememberMeCookie: req.cookies.rememberMe,\r\n        ip: req.ip,\r\n        userAgent: req.get('User-Agent')\r\n      });\r\n    }\r\n\r\n    // Try query parameter (only for specific cases like email verification links)\r\n    if (req.query.session_id) {\r\n      return req.query.session_id;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  // Handle missing session\r\n  handleNoSession(req, res, options = {}) {\r\n    const isApiRequest = req.xhr || req.headers.accept?.includes('application/json');\r\n    \r\n    if (isApiRequest) {\r\n      return res.status(401).json({\r\n        error: 'Authentication required',\r\n        message: options.message || 'Session is required to access this resource',\r\n        code: 'SESSION_REQUIRED',\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    } else {\r\n      // Redirect to login for web requests\r\n      const loginUrl = options.loginUrl || '/login';\r\n      const returnUrl = encodeURIComponent(req.originalUrl);\r\n      return res.redirect(`${loginUrl}?redirect=${returnUrl}`);\r\n    }\r\n  }\r\n\r\n  // Handle invalid session\r\n  handleInvalidSession(req, res, reason, options = {}) {\r\n    const isApiRequest = req.xhr || req.headers.accept?.includes('application/json');\r\n    \r\n    this.logger.logSecurity('Invalid Session Access Attempt', null, {\r\n      sessionId: this.getSessionId(req),\r\n      reason,\r\n      ip: req.ip,\r\n      userAgent: req.get('User-Agent'),\r\n      path: req.originalUrl\r\n    });\r\n\r\n    if (isApiRequest) {\r\n      return res.status(401).json({\r\n        error: 'Invalid session',\r\n        message: options.message || 'Your session is invalid or has expired',\r\n        code: 'SESSION_INVALID',\r\n        reason,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    } else {\r\n      // Redirect to login for web requests\r\n      const loginUrl = options.loginUrl || '/login';\r\n      const returnUrl = encodeURIComponent(req.originalUrl);\r\n      return res.redirect(`${loginUrl}?redirect=${returnUrl}&error=session_expired`);\r\n    }\r\n  }\r\n\r\n  // Handle stale session\r\n  handleStaleSession(req, res, session, options = {}) {\r\n    const isApiRequest = req.xhr || req.headers.accept?.includes('application/json');\r\n    \r\n    this.logger.logSecurity('Stale Session Access Attempt', session.userId, {\r\n      sessionId: session.sessionId,\r\n      sessionAge: Date.now() - session.createdAt.getTime(),\r\n      ip: req.ip,\r\n      userAgent: req.get('User-Agent'),\r\n      path: req.originalUrl\r\n    });\r\n\r\n    if (isApiRequest) {\r\n      return res.status(401).json({\r\n        error: 'Session stale',\r\n        message: options.message || 'Your session is too old, please login again',\r\n        code: 'SESSION_STALE',\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    } else {\r\n      // Redirect to login for web requests\r\n      const loginUrl = options.loginUrl || '/login';\r\n      const returnUrl = encodeURIComponent(req.originalUrl);\r\n      return res.redirect(`${loginUrl}?redirect=${returnUrl}&error=session_stale`);\r\n    }\r\n  }\r\n\r\n  // Session rate limiting middleware\r\n  rateLimit(options = {}) {\r\n    return async (req, res, next) => {\r\n      try {\r\n        if (!req.sessionId) {\r\n          return next(); // No session, skip rate limiting\r\n        }\r\n\r\n        const config = {\r\n          windowMs: options.windowMs || 15 * 60 * 1000, // 15 minutes\r\n          max: options.max || 100, // 100 requests per window\r\n          message: options.message || 'Too many requests from this session'\r\n        };\r\n\r\n        // Use session ID for rate limiting key\r\n        const key = `session_rate_limit:${req.sessionId}`;\r\n        const now = Date.now();\r\n        const windowStart = now - config.windowMs;\r\n\r\n        // This would typically use Redis, but for now we'll implement a simple version\r\n        // In production, you'd want to use the authMiddleware's rateLimit with session key\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Session rate limiting error', error.message);\r\n        next(); // Fail open\r\n      }\r\n    };\r\n  }\r\n\r\n  // Session activity tracking middleware\r\n  trackActivity(options = {}) {\r\n    return async (req, res, next) => {\r\n      // Track session activity after response is sent\r\n      res.on('finish', async () => {\r\n        try {\r\n          if (req.sessionId && req.session) {\r\n            // Update last activity time\r\n            await this.sessionService.refreshSession(req.sessionId, req, {\r\n              maxAge: options.extendSession || false\r\n            });\r\n          }\r\n        } catch (error) {\r\n          this.logger.error('Session activity tracking error', error.message);\r\n        }\r\n      });\r\n\r\n      next();\r\n    };\r\n  }\r\n\r\n  // Session cleanup middleware (for logout)\r\n  cleanup() {\r\n    return async (req, res, next) => {\r\n      // Store original end function\r\n      const originalEnd = res.end;\r\n      \r\n      // Override end function to cleanup after response\r\n      res.end = async function(data) {\r\n        try {\r\n          // Call session cleanup if session exists\r\n          if (req.sessionId) {\r\n            await sessionService.destroySession(req.sessionId, 'request_complete');\r\n          }\r\n        } catch (error) {\r\n          loggerService.error('Session cleanup error', error.message);\r\n        }\r\n        \r\n        // Call original end function\r\n        originalEnd.call(this, data);\r\n      };\r\n\r\n      next();\r\n    };\r\n  }\r\n\r\n  // Generate session response headers\r\n  sessionHeaders(session) {\r\n    return {\r\n      'X-Session-ID': session.sessionId,\r\n      'X-Session-Expires-At': session.expiresAt.toISOString(),\r\n      'X-Session-Max-Age': session.maxAge?.toString() || '',\r\n      'X-Session-Security-Level': session.securityLevel || 'standard'\r\n    };\r\n  }\r\n\r\n  // Set session cookie\r\n  setSessionCookie(res, sessionId, options = {}) {\r\n    const cookieOptions = {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      maxAge: options.maxAge || 24 * 60 * 60 * 1000, // 24 hours\r\n      path: '/',\r\n      ...options\r\n    };\r\n\r\n    // Set main session cookie\r\n    res.cookie('sessionId', sessionId, cookieOptions);\r\n\r\n    // Set remember me cookie if requested\r\n    if (options.rememberMe) {\r\n      const rememberMeOptions = {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'strict',\r\n        maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days\r\n        path: '/'\r\n      };\r\n      \r\n      // Create a remember me identifier (hashed for security)\r\n      const rememberMeId = require('crypto')\r\n        .createHash('sha256')\r\n        .update(`${sessionId}:${Date.now()}`)\r\n        .digest('hex')\r\n        .substring(0, 32);\r\n\r\n      res.cookie('rememberMe', rememberMeId, rememberMeOptions);\r\n      \r\n      // Also set a flag for client-side\r\n      res.cookie('rememberMeEnabled', 'true', {\r\n        httpOnly: false, // Allow JavaScript access\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'strict',\r\n        maxAge: 30 * 24 * 60 * 60 * 1000,\r\n        path: '/'\r\n      });\r\n    } else {\r\n      // Clear any existing remember me cookies\r\n      res.clearCookie('rememberMe', {\r\n        httpOnly: true,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'strict',\r\n        path: '/'\r\n      });\r\n      res.clearCookie('rememberMeEnabled', {\r\n        httpOnly: false,\r\n        secure: process.env.NODE_ENV === 'production',\r\n        sameSite: 'strict',\r\n        path: '/'\r\n      });\r\n    }\r\n  }\r\n\r\n  // Clear session cookie\r\n  clearSessionCookie(res) {\r\n    res.clearCookie('sessionId', {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      path: '/'\r\n    });\r\n\r\n    // Also clear remember me cookies\r\n    res.clearCookie('rememberMe', {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      path: '/'\r\n    });\r\n    res.clearCookie('rememberMeEnabled', {\r\n      httpOnly: false,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      path: '/'\r\n    });\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nconst sessionMiddleware = new SessionMiddleware();\r\n\r\nmodule.exports = {\r\n  SessionMiddleware,\r\n  sessionMiddleware\r\n};"],"mappings":"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","ignoreList":[]}