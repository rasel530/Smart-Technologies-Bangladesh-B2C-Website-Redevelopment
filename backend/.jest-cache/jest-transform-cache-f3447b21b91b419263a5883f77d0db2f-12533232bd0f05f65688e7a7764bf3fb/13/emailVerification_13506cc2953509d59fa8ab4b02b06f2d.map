{"version":3,"names":["PrismaClient","require","configService","loggerService","EmailVerificationMiddleware","constructor","config","logger","prisma","requireEmailVerification","req","res","next","isTestingMode","isEmailVerificationDisabled","emailVerified","user","userId","findUnique","where","id","select","email","status","json","error","message","logSecurity","ip","userAgent","get","path","originalUrl","requiresEmailVerification","requireEmailVerificationFor","routes","currentPath","requiresVerification","some","route","includes","match","RegExp","requiredRoutes","requireEmailVerificationOrAdmin","userRole","role","isEmailVerified","getUserVerificationStatus","createdAt","verified","emailVerificationMiddleware","module","exports"],"sources":["emailVerification.js"],"sourcesContent":["const { PrismaClient } = require('@prisma/client');\r\nconst configService = require('../services/config');\r\nconst loggerService = require('../services/logger');\r\n\r\nclass EmailVerificationMiddleware {\r\n  constructor() {\r\n    this.config = configService;\r\n    this.logger = loggerService;\r\n    this.prisma = new PrismaClient();\r\n  }\r\n\r\n  // Middleware to check if user's email is verified\r\n  requireEmailVerification() {\r\n    return async (req, res, next) => {\r\n      try {\r\n        // Skip verification if testing mode or email verification is disabled\r\n        if (configService.isTestingMode() || configService.isEmailVerificationDisabled()) {\r\n          req.emailVerified = true;\r\n          return next();\r\n        }\r\n\r\n        // If no user is attached (not authenticated), skip verification\r\n        if (!req.user || !req.userId) {\r\n          return next();\r\n        }\r\n\r\n        // Get user from database to check email verification status\r\n        const user = await this.prisma.user.findUnique({\r\n          where: { id: req.userId },\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            emailVerified: true,\r\n            status: true\r\n          }\r\n        });\r\n\r\n        if (!user) {\r\n          return res.status(401).json({\r\n            error: 'User not found',\r\n            message: 'Authenticated user not found in database'\r\n          });\r\n        }\r\n\r\n        // Check if email is verified\r\n        if (!user.emailVerified || user.status === 'PENDING') {\r\n          this.logger.logSecurity('Unverified Email Access Attempt', req.userId, {\r\n            ip: req.ip,\r\n            userAgent: req.get('User-Agent'),\r\n            path: req.originalUrl,\r\n            email: user.email\r\n          });\r\n\r\n          return res.status(403).json({\r\n            error: 'Email not verified',\r\n            message: 'Please verify your email address to access this resource',\r\n            requiresEmailVerification: true\r\n          });\r\n        }\r\n\r\n        // User is verified, proceed\r\n        req.emailVerified = true;\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Email verification middleware error', error.message, {\r\n          userId: req.userId,\r\n          path: req.originalUrl\r\n        });\r\n\r\n        return res.status(500).json({\r\n          error: 'Verification check failed',\r\n          message: 'Unable to verify email status'\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  // Middleware to check email verification for specific routes\r\n  requireEmailVerificationFor(routes = []) {\r\n    return async (req, res, next) => {\r\n      try {\r\n        // Check if current path requires email verification\r\n        const currentPath = req.originalUrl;\r\n        const requiresVerification = routes.some(route => \r\n          currentPath.includes(route) || currentPath.match(new RegExp(route))\r\n        );\r\n\r\n        if (!requiresVerification) {\r\n          return next();\r\n        }\r\n\r\n        // If no user is attached (not authenticated), skip verification\r\n        if (!req.user || !req.userId) {\r\n          return next();\r\n        }\r\n\r\n        // Get user from database\r\n        const user = await this.prisma.user.findUnique({\r\n          where: { id: req.userId },\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            emailVerified: true,\r\n            status: true\r\n          }\r\n        });\r\n\r\n        if (!user) {\r\n          return res.status(401).json({\r\n            error: 'User not found',\r\n            message: 'Authenticated user not found in database'\r\n          });\r\n        }\r\n\r\n        // Check if email is verified\r\n        if (!user.emailVerified || user.status === 'PENDING') {\r\n          this.logger.logSecurity('Protected Route Access - Unverified Email', req.userId, {\r\n            ip: req.ip,\r\n            userAgent: req.get('User-Agent'),\r\n            path: currentPath,\r\n            email: user.email,\r\n            requiredRoutes: routes\r\n          });\r\n\r\n          return res.status(403).json({\r\n            error: 'Email verification required',\r\n            message: 'Please verify your email address to access this resource',\r\n            requiresEmailVerification: true,\r\n            route: currentPath\r\n          });\r\n        }\r\n\r\n        // User is verified, proceed\r\n        req.emailVerified = true;\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Email verification middleware error', error.message, {\r\n          userId: req.userId,\r\n          path: req.originalUrl\r\n        });\r\n\r\n        return res.status(500).json({\r\n          error: 'Verification check failed',\r\n          message: 'Unable to verify email status'\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  // Middleware to check email verification with optional bypass for admin users\r\n  requireEmailVerificationOrAdmin() {\r\n    return async (req, res, next) => {\r\n      try {\r\n        // If no user is attached (not authenticated), skip verification\r\n        if (!req.user || !req.userId) {\r\n          return next();\r\n        }\r\n\r\n        // Admin users can bypass email verification\r\n        if (req.userRole === 'ADMIN') {\r\n          req.emailVerified = true;\r\n          return next();\r\n        }\r\n\r\n        // Get user from database\r\n        const user = await this.prisma.user.findUnique({\r\n          where: { id: req.userId },\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            emailVerified: true,\r\n            status: true,\r\n            role: true\r\n          }\r\n        });\r\n\r\n        if (!user) {\r\n          return res.status(401).json({\r\n            error: 'User not found',\r\n            message: 'Authenticated user not found in database'\r\n          });\r\n        }\r\n\r\n        // Check if email is verified for non-admin users\r\n        if (!user.emailVerified || user.status === 'PENDING') {\r\n          this.logger.logSecurity('Admin Bypass Attempt - Unverified Email', req.userId, {\r\n            ip: req.ip,\r\n            userAgent: req.get('User-Agent'),\r\n            path: req.originalUrl,\r\n            email: user.email,\r\n            userRole: user.role\r\n          });\r\n\r\n          return res.status(403).json({\r\n            error: 'Email not verified',\r\n            message: 'Please verify your email address to access this resource',\r\n            requiresEmailVerification: true\r\n          });\r\n        }\r\n\r\n        // User is verified, proceed\r\n        req.emailVerified = true;\r\n        next();\r\n\r\n      } catch (error) {\r\n        this.logger.error('Email verification middleware error', error.message, {\r\n          userId: req.userId,\r\n          path: req.originalUrl\r\n        });\r\n\r\n        return res.status(500).json({\r\n          error: 'Verification check failed',\r\n          message: 'Unable to verify email status'\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  // Helper method to check if user email is verified\r\n  async isEmailVerified(userId) {\r\n    try {\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: {\r\n          id: true,\r\n          emailVerified: true,\r\n          status: true\r\n        }\r\n      });\r\n\r\n      return user && user.emailVerified && user.status !== 'PENDING';\r\n    } catch (error) {\r\n      this.logger.error('Error checking email verification status', error.message, {\r\n        userId\r\n      });\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Helper method to get user verification status\r\n  async getUserVerificationStatus(userId) {\r\n    try {\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: {\r\n          id: true,\r\n          email: true,\r\n          emailVerified: true,\r\n          status: true,\r\n          createdAt: true\r\n        }\r\n      });\r\n\r\n      if (!user) {\r\n        return {\r\n          verified: false,\r\n          status: 'NOT_FOUND',\r\n          message: 'User not found'\r\n        };\r\n      }\r\n\r\n      return {\r\n        verified: !!user.emailVerified && user.status !== 'PENDING',\r\n        status: user.status,\r\n        emailVerified: user.emailVerified,\r\n        email: user.email,\r\n        createdAt: user.createdAt\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Error getting user verification status', error.message, {\r\n        userId\r\n      });\r\n      return {\r\n        verified: false,\r\n        status: 'ERROR',\r\n        message: 'Unable to check verification status'\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nconst emailVerificationMiddleware = new EmailVerificationMiddleware();\r\n\r\nmodule.exports = {\r\n  EmailVerificationMiddleware,\r\n  emailVerificationMiddleware\r\n};"],"mappings":"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","ignoreList":[]}