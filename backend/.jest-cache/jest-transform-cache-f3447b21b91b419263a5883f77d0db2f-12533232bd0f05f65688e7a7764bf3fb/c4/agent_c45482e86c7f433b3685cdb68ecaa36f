43d61c6521b9f7b11e29cf2135626ee7
'use strict';

/**
 * Module dependencies.
 */
const {
  agent: Agent
} = require('superagent');
const methods = require('methods');
const http = require('http');
let http2;
try {
  http2 = require('http2'); // eslint-disable-line global-require
} catch (_) {
  // eslint-disable-line no-empty
}
const Test = require('./test.js');

/**
 * Initialize a new `TestAgent`.
 *
 * @param {Function|Server} app
 * @param {Object} options
 * @api public
 */

function TestAgent(app, options = {}) {
  if (!(this instanceof TestAgent)) return new TestAgent(app, options);
  const agent = new Agent(options);
  Object.assign(this, agent);
  this._options = options;
  if (typeof app === 'function') {
    if (options.http2) {
      if (!http2) {
        throw new Error('supertest: this version of Node.js does not support http2');
      }
      app = http2.createServer(app); // eslint-disable-line no-param-reassign
    } else {
      app = http.createServer(app); // eslint-disable-line no-param-reassign
    }
  }
  this.app = app;
}

/**
 * Inherits from `Agent.prototype`.
 */

Object.setPrototypeOf(TestAgent.prototype, Agent.prototype);

// Preserve the original query method before overriding HTTP methods
const originalQuery = Agent.prototype.query;

// set a host name
TestAgent.prototype.host = function (host) {
  this._host = host;
  return this;
};

// override HTTP verb methods
methods.forEach(function (method) {
  // Skip 'query' method to prevent overwriting superagent's query functionality
  if (method === 'query') {
    return;
  }
  TestAgent.prototype[method] = function (url, fn) {
    // eslint-disable-line no-unused-vars
    const req = new Test(this.app, method.toUpperCase(), url);
    if (this._options.http2) {
      req.http2();
    }
    if (this._host) {
      req.set('host', this._host);
    }
    req.on('response', this._saveCookies.bind(this));
    req.on('redirect', this._saveCookies.bind(this));
    req.on('redirect', this._attachCookies.bind(this, req));
    this._setDefaults(req);
    this._attachCookies(req);
    return req;
  };
});

// Restore the original query method
TestAgent.prototype.query = originalQuery;
TestAgent.prototype.del = TestAgent.prototype.delete;

/**
 * Expose `Agent`.
 */

module.exports = TestAgent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhZ2VudCIsIkFnZW50IiwicmVxdWlyZSIsIm1ldGhvZHMiLCJodHRwIiwiaHR0cDIiLCJfIiwiVGVzdCIsIlRlc3RBZ2VudCIsImFwcCIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJfb3B0aW9ucyIsIkVycm9yIiwiY3JlYXRlU2VydmVyIiwic2V0UHJvdG90eXBlT2YiLCJwcm90b3R5cGUiLCJvcmlnaW5hbFF1ZXJ5IiwicXVlcnkiLCJob3N0IiwiX2hvc3QiLCJmb3JFYWNoIiwibWV0aG9kIiwidXJsIiwiZm4iLCJyZXEiLCJ0b1VwcGVyQ2FzZSIsInNldCIsIm9uIiwiX3NhdmVDb29raWVzIiwiYmluZCIsIl9hdHRhY2hDb29raWVzIiwiX3NldERlZmF1bHRzIiwiZGVsIiwiZGVsZXRlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImFnZW50LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLyoqXG4gKiBNb2R1bGUgZGVwZW5kZW5jaWVzLlxuICovXG5cbmNvbnN0IHsgYWdlbnQ6IEFnZW50IH0gPSByZXF1aXJlKCdzdXBlcmFnZW50Jyk7XG5jb25zdCBtZXRob2RzID0gcmVxdWlyZSgnbWV0aG9kcycpO1xuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcbmxldCBodHRwMjtcbnRyeSB7XG4gIGh0dHAyID0gcmVxdWlyZSgnaHR0cDInKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBnbG9iYWwtcmVxdWlyZVxufSBjYXRjaCAoXykge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWVtcHR5XG59XG5jb25zdCBUZXN0ID0gcmVxdWlyZSgnLi90ZXN0LmpzJyk7XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBhIG5ldyBgVGVzdEFnZW50YC5cbiAqXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufFNlcnZlcn0gYXBwXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICogQGFwaSBwdWJsaWNcbiAqL1xuXG5mdW5jdGlvbiBUZXN0QWdlbnQoYXBwLCBvcHRpb25zID0ge30pIHtcbiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRlc3RBZ2VudCkpIHJldHVybiBuZXcgVGVzdEFnZW50KGFwcCwgb3B0aW9ucyk7XG5cbiAgY29uc3QgYWdlbnQgPSBuZXcgQWdlbnQob3B0aW9ucyk7XG4gIE9iamVjdC5hc3NpZ24odGhpcywgYWdlbnQpO1xuXG4gIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuXG4gIGlmICh0eXBlb2YgYXBwID09PSAnZnVuY3Rpb24nKSB7XG4gICAgaWYgKG9wdGlvbnMuaHR0cDIpIHtcbiAgICAgIGlmICghaHR0cDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdzdXBlcnRlc3Q6IHRoaXMgdmVyc2lvbiBvZiBOb2RlLmpzIGRvZXMgbm90IHN1cHBvcnQgaHR0cDInXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBhcHAgPSBodHRwMi5jcmVhdGVTZXJ2ZXIoYXBwKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuICAgIH0gZWxzZSB7XG4gICAgICBhcHAgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgfVxuICB9XG4gIHRoaXMuYXBwID0gYXBwO1xufVxuXG4vKipcbiAqIEluaGVyaXRzIGZyb20gYEFnZW50LnByb3RvdHlwZWAuXG4gKi9cblxuT2JqZWN0LnNldFByb3RvdHlwZU9mKFRlc3RBZ2VudC5wcm90b3R5cGUsIEFnZW50LnByb3RvdHlwZSk7XG5cbi8vIFByZXNlcnZlIHRoZSBvcmlnaW5hbCBxdWVyeSBtZXRob2QgYmVmb3JlIG92ZXJyaWRpbmcgSFRUUCBtZXRob2RzXG5jb25zdCBvcmlnaW5hbFF1ZXJ5ID0gQWdlbnQucHJvdG90eXBlLnF1ZXJ5O1xuXG4vLyBzZXQgYSBob3N0IG5hbWVcblRlc3RBZ2VudC5wcm90b3R5cGUuaG9zdCA9IGZ1bmN0aW9uKGhvc3QpIHtcbiAgdGhpcy5faG9zdCA9IGhvc3Q7XG4gIHJldHVybiB0aGlzO1xufTtcblxuLy8gb3ZlcnJpZGUgSFRUUCB2ZXJiIG1ldGhvZHNcbm1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbihtZXRob2QpIHtcbiAgLy8gU2tpcCAncXVlcnknIG1ldGhvZCB0byBwcmV2ZW50IG92ZXJ3cml0aW5nIHN1cGVyYWdlbnQncyBxdWVyeSBmdW5jdGlvbmFsaXR5XG4gIGlmIChtZXRob2QgPT09ICdxdWVyeScpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBUZXN0QWdlbnQucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih1cmwsIGZuKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICBjb25zdCByZXEgPSBuZXcgVGVzdCh0aGlzLmFwcCwgbWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCk7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMuaHR0cDIpIHtcbiAgICAgIHJlcS5odHRwMigpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9ob3N0KSB7XG4gICAgICByZXEuc2V0KCdob3N0JywgdGhpcy5faG9zdCk7XG4gICAgfVxuXG4gICAgcmVxLm9uKCdyZXNwb25zZScsIHRoaXMuX3NhdmVDb29raWVzLmJpbmQodGhpcykpO1xuICAgIHJlcS5vbigncmVkaXJlY3QnLCB0aGlzLl9zYXZlQ29va2llcy5iaW5kKHRoaXMpKTtcbiAgICByZXEub24oJ3JlZGlyZWN0JywgdGhpcy5fYXR0YWNoQ29va2llcy5iaW5kKHRoaXMsIHJlcSkpO1xuICAgIHRoaXMuX3NldERlZmF1bHRzKHJlcSk7XG4gICAgdGhpcy5fYXR0YWNoQ29va2llcyhyZXEpO1xuXG4gICAgcmV0dXJuIHJlcTtcbiAgfTtcbn0pO1xuXG4vLyBSZXN0b3JlIHRoZSBvcmlnaW5hbCBxdWVyeSBtZXRob2RcblRlc3RBZ2VudC5wcm90b3R5cGUucXVlcnkgPSBvcmlnaW5hbFF1ZXJ5O1xuXG5UZXN0QWdlbnQucHJvdG90eXBlLmRlbCA9IFRlc3RBZ2VudC5wcm90b3R5cGUuZGVsZXRlO1xuXG4vKipcbiAqIEV4cG9zZSBgQWdlbnRgLlxuICovXG5cbm1vZHVsZS5leHBvcnRzID0gVGVzdEFnZW50O1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUVaO0FBQ0E7QUFDQTtBQUVBLE1BQU07RUFBRUEsS0FBSyxFQUFFQztBQUFNLENBQUMsR0FBR0MsT0FBTyxDQUFDLFlBQVksQ0FBQztBQUM5QyxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFDbEMsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzVCLElBQUlHLEtBQUs7QUFDVCxJQUFJO0VBQ0ZBLEtBQUssR0FBR0gsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDNUIsQ0FBQyxDQUFDLE9BQU9JLENBQUMsRUFBRTtFQUNWO0FBQUE7QUFFRixNQUFNQyxJQUFJLEdBQUdMLE9BQU8sQ0FBQyxXQUFXLENBQUM7O0FBRWpDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQVNNLFNBQVNBLENBQUNDLEdBQUcsRUFBRUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3BDLElBQUksRUFBRSxJQUFJLFlBQVlGLFNBQVMsQ0FBQyxFQUFFLE9BQU8sSUFBSUEsU0FBUyxDQUFDQyxHQUFHLEVBQUVDLE9BQU8sQ0FBQztFQUVwRSxNQUFNVixLQUFLLEdBQUcsSUFBSUMsS0FBSyxDQUFDUyxPQUFPLENBQUM7RUFDaENDLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDLElBQUksRUFBRVosS0FBSyxDQUFDO0VBRTFCLElBQUksQ0FBQ2EsUUFBUSxHQUFHSCxPQUFPO0VBRXZCLElBQUksT0FBT0QsR0FBRyxLQUFLLFVBQVUsRUFBRTtJQUM3QixJQUFJQyxPQUFPLENBQUNMLEtBQUssRUFBRTtNQUNqQixJQUFJLENBQUNBLEtBQUssRUFBRTtRQUNWLE1BQU0sSUFBSVMsS0FBSyxDQUNiLDJEQUNGLENBQUM7TUFDSDtNQUNBTCxHQUFHLEdBQUdKLEtBQUssQ0FBQ1UsWUFBWSxDQUFDTixHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLENBQUMsTUFBTTtNQUNMQSxHQUFHLEdBQUdMLElBQUksQ0FBQ1csWUFBWSxDQUFDTixHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2hDO0VBQ0Y7RUFDQSxJQUFJLENBQUNBLEdBQUcsR0FBR0EsR0FBRztBQUNoQjs7QUFFQTtBQUNBO0FBQ0E7O0FBRUFFLE1BQU0sQ0FBQ0ssY0FBYyxDQUFDUixTQUFTLENBQUNTLFNBQVMsRUFBRWhCLEtBQUssQ0FBQ2dCLFNBQVMsQ0FBQzs7QUFFM0Q7QUFDQSxNQUFNQyxhQUFhLEdBQUdqQixLQUFLLENBQUNnQixTQUFTLENBQUNFLEtBQUs7O0FBRTNDO0FBQ0FYLFNBQVMsQ0FBQ1MsU0FBUyxDQUFDRyxJQUFJLEdBQUcsVUFBU0EsSUFBSSxFQUFFO0VBQ3hDLElBQUksQ0FBQ0MsS0FBSyxHQUFHRCxJQUFJO0VBQ2pCLE9BQU8sSUFBSTtBQUNiLENBQUM7O0FBRUQ7QUFDQWpCLE9BQU8sQ0FBQ21CLE9BQU8sQ0FBQyxVQUFTQyxNQUFNLEVBQUU7RUFDL0I7RUFDQSxJQUFJQSxNQUFNLEtBQUssT0FBTyxFQUFFO0lBQ3RCO0VBQ0Y7RUFFQWYsU0FBUyxDQUFDUyxTQUFTLENBQUNNLE1BQU0sQ0FBQyxHQUFHLFVBQVNDLEdBQUcsRUFBRUMsRUFBRSxFQUFFO0lBQUU7SUFDaEQsTUFBTUMsR0FBRyxHQUFHLElBQUluQixJQUFJLENBQUMsSUFBSSxDQUFDRSxHQUFHLEVBQUVjLE1BQU0sQ0FBQ0ksV0FBVyxDQUFDLENBQUMsRUFBRUgsR0FBRyxDQUFDO0lBQ3pELElBQUksSUFBSSxDQUFDWCxRQUFRLENBQUNSLEtBQUssRUFBRTtNQUN2QnFCLEdBQUcsQ0FBQ3JCLEtBQUssQ0FBQyxDQUFDO0lBQ2I7SUFFQSxJQUFJLElBQUksQ0FBQ2dCLEtBQUssRUFBRTtNQUNkSyxHQUFHLENBQUNFLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDUCxLQUFLLENBQUM7SUFDN0I7SUFFQUssR0FBRyxDQUFDRyxFQUFFLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQ0MsWUFBWSxDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaERMLEdBQUcsQ0FBQ0csRUFBRSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUNDLFlBQVksQ0FBQ0MsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hETCxHQUFHLENBQUNHLEVBQUUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDRyxjQUFjLENBQUNELElBQUksQ0FBQyxJQUFJLEVBQUVMLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELElBQUksQ0FBQ08sWUFBWSxDQUFDUCxHQUFHLENBQUM7SUFDdEIsSUFBSSxDQUFDTSxjQUFjLENBQUNOLEdBQUcsQ0FBQztJQUV4QixPQUFPQSxHQUFHO0VBQ1osQ0FBQztBQUNILENBQUMsQ0FBQzs7QUFFRjtBQUNBbEIsU0FBUyxDQUFDUyxTQUFTLENBQUNFLEtBQUssR0FBR0QsYUFBYTtBQUV6Q1YsU0FBUyxDQUFDUyxTQUFTLENBQUNpQixHQUFHLEdBQUcxQixTQUFTLENBQUNTLFNBQVMsQ0FBQ2tCLE1BQU07O0FBRXBEO0FBQ0E7QUFDQTs7QUFFQUMsTUFBTSxDQUFDQyxPQUFPLEdBQUc3QixTQUFTIiwiaWdub3JlTGlzdCI6W119