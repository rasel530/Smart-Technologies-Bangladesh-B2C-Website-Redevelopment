{"version":3,"names":["express","require","body","validationResult","bcrypt","jwt","PrismaClient","router","Router","prisma","handleValidationErrors","req","res","next","errors","isEmpty","status","json","error","details","array","post","isEmail","normalizeEmail","isLength","min","notEmpty","trim","optional","isMobilePhone","email","password","firstName","lastName","phone","existingUser","user","findFirst","where","OR","field","securityConfig","configService","getSecurityConfig","hashedPassword","hash","bcryptRounds","create","data","role","select","id","createdAt","jwtSecretRegister","process","env","JWT_SECRET","Error","token","sign","userId","expiresIn","message","console","NODE_ENV","findUnique","isValidPassword","compare","update","lastLoginAt","Date","jwtSecretLogin","jwtSecretRefresh","decoded","verify","jwtSecretNew","newToken","module","exports"],"sources":["auth.js"],"sourcesContent":["const express = require('express');\r\nconst { body, validationResult } = require('express-validator');\r\nconst bcrypt = require('bcryptjs');\r\nconst jwt = require('jsonwebtoken');\r\nconst { PrismaClient } = require('@prisma/client');\r\n\r\nconst router = express.Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Validation middleware\r\nconst handleValidationErrors = (req, res, next) => {\r\n  const errors = validationResult(req);\r\n  if (!errors.isEmpty()) {\r\n    return res.status(400).json({\r\n      error: 'Validation failed',\r\n      details: errors.array()\r\n    });\r\n  }\r\n  next();\r\n};\r\n\r\n// Register endpoint\r\nrouter.post('/register', [\r\n  body('email').isEmail().normalizeEmail(),\r\n  body('password').isLength({ min: 6 }),\r\n  body('firstName').notEmpty().trim(),\r\n  body('lastName').notEmpty().trim(),\r\n  body('phone').optional().isMobilePhone('any')\r\n], handleValidationErrors, async (req, res) => {\r\n  try {\r\n    const { email, password, firstName, lastName, phone } = req.body;\r\n\r\n    // Check if user already exists\r\n    const existingUser = await prisma.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          { email },\r\n          ...(phone ? [{ phone }] : [])\r\n        ]\r\n      }\r\n    });\r\n\r\n    if (existingUser) {\r\n      return res.status(409).json({\r\n        error: 'User already exists',\r\n        field: existingUser.email === email ? 'email' : 'phone'\r\n      });\r\n    }\r\n\r\n    // Hash password\r\n    const securityConfig = require('../services/config').configService.getSecurityConfig();\r\n    const hashedPassword = await bcrypt.hash(password, securityConfig.bcryptRounds);\r\n\r\n    // Create user\r\n    const user = await prisma.user.create({\r\n      data: {\r\n        email,\r\n        password: hashedPassword,\r\n        firstName,\r\n        lastName,\r\n        phone,\r\n        role: 'CUSTOMER'\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        phone: true,\r\n        role: true,\r\n        status: true,\r\n        createdAt: true\r\n      }\r\n    });\r\n\r\n    // Generate JWT token\r\n    const jwtSecretRegister = process.env.JWT_SECRET;\r\n    if (!jwtSecretRegister) {\r\n      throw new Error('JWT_SECRET environment variable is required');\r\n    }\r\n    \r\n    const token = jwt.sign(\r\n      { userId: user.id, email: user.email, role: user.role },\r\n      jwtSecretRegister,\r\n      { expiresIn: '7d' }\r\n    );\r\n\r\n    res.status(201).json({\r\n      message: 'User registered successfully',\r\n      user,\r\n      token\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Registration error:', error);\r\n    res.status(500).json({\r\n      error: 'Registration failed',\r\n      message: process.env.NODE_ENV === 'development' ? error.message : 'Internal server error'\r\n    });\r\n  }\r\n});\r\n\r\n// Login endpoint\r\nrouter.post('/login', [\r\n  body('email').isEmail().normalizeEmail(),\r\n  body('password').notEmpty()\r\n], handleValidationErrors, async (req, res) => {\r\n  try {\r\n    const { email, password } = req.body;\r\n\r\n    // Find user\r\n    const user = await prisma.user.findUnique({\r\n      where: { email }\r\n    });\r\n\r\n    if (!user || !user.password) {\r\n      return res.status(401).json({\r\n        error: 'Invalid credentials'\r\n      });\r\n    }\r\n\r\n    // Verify password\r\n    const isValidPassword = await bcrypt.compare(password, user.password);\r\n    if (!isValidPassword) {\r\n      return res.status(401).json({\r\n        error: 'Invalid credentials'\r\n      });\r\n    }\r\n\r\n    // Update last login\r\n    await prisma.user.update({\r\n      where: { id: user.id },\r\n      data: { lastLoginAt: new Date() }\r\n    });\r\n\r\n    // Generate JWT token\r\n    const jwtSecretLogin = process.env.JWT_SECRET;\r\n    if (!jwtSecretLogin) {\r\n      throw new Error('JWT_SECRET environment variable is required');\r\n    }\r\n    \r\n    const token = jwt.sign(\r\n      { userId: user.id, email: user.email, role: user.role },\r\n      jwtSecretLogin,\r\n      { expiresIn: '7d' }\r\n    );\r\n\r\n    res.json({\r\n      message: 'Login successful',\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        firstName: user.firstName,\r\n        lastName: user.lastName,\r\n        role: user.role,\r\n        status: user.status\r\n      },\r\n      token\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Login error:', error);\r\n    res.status(500).json({\r\n      error: 'Login failed',\r\n      message: process.env.NODE_ENV === 'development' ? error.message : 'Internal server error'\r\n    });\r\n  }\r\n});\r\n\r\n// Logout endpoint\r\nrouter.post('/logout', async (req, res) => {\r\n  try {\r\n    // In a real implementation, you would invalidate the token\r\n    // For now, we'll just return success\r\n    res.json({\r\n      message: 'Logout successful'\r\n    });\r\n  } catch (error) {\r\n    console.error('Logout error:', error);\r\n    res.status(500).json({\r\n      error: 'Logout failed',\r\n      message: process.env.NODE_ENV === 'development' ? error.message : 'Internal server error'\r\n    });\r\n  }\r\n});\r\n\r\n// Refresh token endpoint\r\nrouter.post('/refresh', async (req, res) => {\r\n  try {\r\n    const { token } = req.body;\r\n\r\n    if (!token) {\r\n      return res.status(401).json({\r\n        error: 'Token required'\r\n      });\r\n    }\r\n\r\n    // Verify token\r\n    const jwtSecretRefresh = process.env.JWT_SECRET;\r\n    if (!jwtSecretRefresh) {\r\n      throw new Error('JWT_SECRET environment variable is required');\r\n    }\r\n    \r\n    const decoded = jwt.verify(token, jwtSecretRefresh);\r\n    \r\n    // Get user info\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: decoded.userId },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        role: true,\r\n        status: true\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      return res.status(401).json({\r\n        error: 'User not found'\r\n      });\r\n    }\r\n\r\n    // Generate new token\r\n    const jwtSecretNew = process.env.JWT_SECRET;\r\n    if (!jwtSecretNew) {\r\n      throw new Error('JWT_SECRET environment variable is required');\r\n    }\r\n    \r\n    const newToken = jwt.sign(\r\n      { userId: user.id, email: user.email, role: user.role },\r\n      jwtSecretNew,\r\n      { expiresIn: '7d' }\r\n    );\r\n\r\n    res.json({\r\n      message: 'Token refreshed successfully',\r\n      user,\r\n      token: newToken\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Token refresh error:', error);\r\n    res.status(401).json({\r\n      error: 'Invalid token',\r\n      message: process.env.NODE_ENV === 'development' ? error.message : 'Token expired or invalid'\r\n    });\r\n  }\r\n});\r\n\r\nmodule.exports = router;"],"mappings":"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","ignoreList":[]}