{"version":3,"names":["crypto","require","PrismaClient","configService","loggerService","SessionService","constructor","prisma","redis","config","logger","initializeRedis","Redis","redisUrl","get","warn","createClient","url","retry_delay_on_failover","max_retries_per_request","connectTimeout","lazyConnect","socket","keepAlive","reconnectStrategy","retries","error","Math","min","pipeline","multi","exec","execMulti","on","err","message","info","connect","generateSessionId","randomBytes","toString","generateDeviceFingerprint","req","userAgent","acceptLanguage","acceptEncoding","fingerprint","createHash","update","digest","substring","createSession","userId","options","sessionId","deviceFingerprint","now","Date","defaultMaxAge","rememberMe","sessionConfig","ip","createdAt","lastActivity","expiresAt","getTime","maxAge","isActive","loginType","securityLevel","persistent","deviceTrusted","sessionKey","ttl","floor","setEx","JSON","stringify","userSessionsKey","zAdd","score","value","expire","userSession","create","data","token","logSecurity","Error","validateSession","valid","reason","sessionData","sessionString","parse","session","findUnique","where","include","user","path","originalUrl","destroySession","securityChecks","performSecurityChecks","passed","ipChanged","isIPChangeAllowed","currentFingerprint","oldIP","newIP","oldParts","split","newParts","length","refreshSession","validation","success","newExpiry","toISOString","zRem","del","delete","id","destroyAllUserSessions","exceptSessionId","destroyedSessions","sessionIds","zRange","push","sessions","findMany","not","destroyedCount","getUserSessions","dbSessions","gt","orderBy","map","cleanupExpiredSessions","cleanedCount","pattern","keys","key","validSessions","exists","result","deleteMany","lt","count","timestamp","getSessionStats","stats","totalSessions","activeSessions","expiredSessions","redisAvailable","total","active","Promise","all","validateRememberMeToken","tokenKey","tokenString","tokenData","rememberMeToken","createRememberMeToken","userTokensKey","refreshFromRememberMeToken","expectedFingerprint","actualFingerprint","sessionResult","newSessionId","cleanupExpiredRememberMeTokens","sessionService","module","exports"],"sources":["sessionService.js"],"sourcesContent":["const crypto = require('crypto');\r\nconst { PrismaClient } = require('@prisma/client');\r\nconst { configService } = require('./config');\r\nconst { loggerService } = require('./logger');\r\n\r\nclass SessionService {\r\n  constructor() {\r\n    this.prisma = new PrismaClient();\r\n    this.redis = null;\r\n    this.config = configService;\r\n    this.logger = loggerService;\r\n    this.initializeRedis();\r\n  }\r\n\r\n  async initializeRedis() {\r\n    try {\r\n      const Redis = require('redis');\r\n      const redisUrl = this.config.get('REDIS_URL');\r\n      \r\n      if (!redisUrl) {\r\n        this.logger.warn('REDIS_URL not configured, session management will use database only');\r\n        return;\r\n      }\r\n\r\n      this.redis = Redis.createClient({\r\n        url: redisUrl,\r\n        retry_delay_on_failover: 100,\r\n        max_retries_per_request: 3,\r\n        connectTimeout: 10000,\r\n        lazyConnect: false,\r\n        socket: {\r\n          keepAlive: true,\r\n          reconnectStrategy: (retries) => {\r\n            if (retries > 10) {\r\n              this.logger.error('Redis reconnection failed after 10 attempts');\r\n              return false;\r\n            }\r\n            return Math.min(retries * 100, 3000);\r\n          }\r\n        }\r\n      });\r\n\r\n      // Add pipeline method support\r\n      this.redis.pipeline = () => {\r\n        const pipeline = this.redis.multi();\r\n        pipeline.exec = () => this.redis.execMulti(pipeline);\r\n        return pipeline;\r\n      };\r\n\r\n      this.redis.on('error', (err) => {\r\n        this.logger.error('Redis connection error in session service', err.message);\r\n        // Don't set redis to null, allow reconnection\r\n      });\r\n\r\n      this.redis.on('connect', () => {\r\n        this.logger.info('Redis connected for session service');\r\n      });\r\n\r\n      this.redis.on('ready', () => {\r\n        this.logger.info('Redis ready for session service');\r\n      });\r\n\r\n      this.redis.on('reconnecting', () => {\r\n        this.logger.info('Redis reconnecting for session service');\r\n      });\r\n\r\n      await this.redis.connect();\r\n    } catch (error) {\r\n      this.logger.error('Failed to initialize Redis for session service', error.message);\r\n      this.redis = null;\r\n    }\r\n  }\r\n\r\n  // Generate secure session ID\r\n  generateSessionId() {\r\n    return crypto.randomBytes(32).toString('hex');\r\n  }\r\n\r\n  // Generate device fingerprint\r\n  generateDeviceFingerprint(req) {\r\n    const userAgent = req.get('User-Agent') || '';\r\n    const acceptLanguage = req.get('Accept-Language') || '';\r\n    const acceptEncoding = req.get('Accept-Encoding') || '';\r\n    \r\n    const fingerprint = crypto\r\n      .createHash('sha256')\r\n      .update(`${userAgent}|${acceptLanguage}|${acceptEncoding}`)\r\n      .digest('hex');\r\n    \r\n    return fingerprint.substring(0, 32); // Truncate for storage efficiency\r\n  }\r\n\r\n  // Create new session\r\n  async createSession(userId, req, options = {}) {\r\n    try {\r\n      const sessionId = this.generateSessionId();\r\n      const deviceFingerprint = this.generateDeviceFingerprint(req);\r\n      const now = new Date();\r\n      \r\n      // Enhanced session configuration for remember me functionality\r\n      const defaultMaxAge = options.rememberMe ?\r\n        7 * 24 * 60 * 60 * 1000 : // 7 days for remember me\r\n        24 * 60 * 60 * 1000;  // 24 hours default\r\n      \r\n      const sessionConfig = {\r\n        userId,\r\n        sessionId,\r\n        deviceFingerprint,\r\n        ip: req.ip,\r\n        userAgent: req.get('User-Agent'),\r\n        createdAt: now,\r\n        lastActivity: now,\r\n        expiresAt: new Date(now.getTime() + (options.maxAge || defaultMaxAge)),\r\n        isActive: true,\r\n        loginType: options.loginType || 'password',\r\n        rememberMe: options.rememberMe || false,\r\n        securityLevel: options.securityLevel || 'standard',\r\n        // Enhanced remember me features\r\n        persistent: options.rememberMe || false,\r\n        deviceTrusted: options.rememberMe || false,\r\n        maxAge: options.maxAge || defaultMaxAge\r\n      };\r\n\r\n      // Store in Redis if available\r\n      if (this.redis) {\r\n        const sessionKey = `session:${sessionId}`;\r\n        const ttl = Math.floor((sessionConfig.expiresAt.getTime() - now.getTime()) / 1000);\r\n        \r\n        await this.redis.setEx(sessionKey, ttl, JSON.stringify(sessionConfig));\r\n        \r\n        // Also store user session index for easy lookup\r\n        const userSessionsKey = `user_sessions:${userId}`;\r\n        await this.redis.zAdd(userSessionsKey, [{ \r\n          score: now.getTime(), \r\n          value: sessionId \r\n        }]);\r\n        await this.redis.expire(userSessionsKey, 7 * 24 * 60 * 60); // 7 days\r\n        \r\n        this.logger.info('Session created in Redis', { sessionId, userId });\r\n      } else {\r\n        // Fallback to database\r\n        await this.prisma.userSession.create({\r\n          data: {\r\n            userId,\r\n            token: sessionId,\r\n            expiresAt: sessionConfig.expiresAt\r\n          }\r\n        });\r\n        \r\n        this.logger.info('Session created in database', { sessionId, userId });\r\n      }\r\n\r\n      // Log session creation with enhanced remember me details\r\n      this.logger.logSecurity('Session Created', userId, {\r\n        sessionId,\r\n        ip: req.ip,\r\n        userAgent: req.get('User-Agent'),\r\n        loginType: options.loginType,\r\n        rememberMe: options.rememberMe,\r\n        persistent: sessionConfig.persistent,\r\n        maxAge: sessionConfig.maxAge,\r\n        expiresAt: sessionConfig.expiresAt\r\n      });\r\n\r\n      return {\r\n        sessionId,\r\n        expiresAt: sessionConfig.expiresAt,\r\n        maxAge: sessionConfig.maxAge,\r\n        rememberMe: sessionConfig.rememberMe,\r\n        persistent: sessionConfig.persistent\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Failed to create session', error.message);\r\n      throw new Error('Session creation failed');\r\n    }\r\n  }\r\n\r\n  // Validate session\r\n  async validateSession(sessionId, req) {\r\n    try {\r\n      if (!sessionId) {\r\n        return { valid: false, reason: 'No session ID provided' };\r\n      }\r\n\r\n      let sessionData = null;\r\n\r\n      // Try Redis first\r\n      if (this.redis) {\r\n        const sessionKey = `session:${sessionId}`;\r\n        const sessionString = await this.redis.get(sessionKey);\r\n        \r\n        if (sessionString) {\r\n          sessionData = JSON.parse(sessionString);\r\n        }\r\n      } else {\r\n        // Fallback to database\r\n        const session = await this.prisma.userSession.findUnique({\r\n          where: { token: sessionId },\r\n          include: { user: true }\r\n        });\r\n\r\n        if (session && session.expiresAt > new Date()) {\r\n          sessionData = {\r\n            userId: session.userId,\r\n            sessionId,\r\n            ip: req.ip,\r\n            userAgent: req.get('User-Agent'),\r\n            createdAt: session.createdAt,\r\n            lastActivity: session.createdAt,\r\n            expiresAt: session.expiresAt,\r\n            isActive: true\r\n          };\r\n        }\r\n      }\r\n\r\n      if (!sessionData) {\r\n        this.logger.logSecurity('Invalid Session Attempt', null, {\r\n          sessionId,\r\n          ip: req.ip,\r\n          userAgent: req.get('User-Agent'),\r\n          path: req.originalUrl\r\n        });\r\n        return { valid: false, reason: 'Session not found or expired' };\r\n      }\r\n\r\n      // Check expiration\r\n      const now = new Date();\r\n      if (sessionData.expiresAt && now > sessionData.expiresAt) {\r\n        await this.destroySession(sessionId);\r\n        return { valid: false, reason: 'Session expired' };\r\n      }\r\n\r\n      // Security checks\r\n      const securityChecks = this.performSecurityChecks(sessionData, req);\r\n      if (!securityChecks.passed) {\r\n        await this.destroySession(sessionId);\r\n        this.logger.logSecurity('Session Security Check Failed', sessionData.userId, {\r\n          sessionId,\r\n          reason: securityChecks.reason,\r\n          ip: req.ip,\r\n          userAgent: req.get('User-Agent')\r\n        });\r\n        return { valid: false, reason: securityChecks.reason };\r\n      }\r\n\r\n      // Update last activity\r\n      sessionData.lastActivity = now;\r\n      if (this.redis) {\r\n        const sessionKey = `session:${sessionId}`;\r\n        const ttl = Math.floor((sessionData.expiresAt.getTime() - now.getTime()) / 1000);\r\n        await this.redis.setEx(sessionKey, ttl, JSON.stringify(sessionData));\r\n      }\r\n\r\n      return {\r\n        valid: true,\r\n        session: sessionData,\r\n        userId: sessionData.userId\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Session validation error', error.message);\r\n      return { valid: false, reason: 'Session validation failed' };\r\n    }\r\n  }\r\n\r\n  // Perform security checks on session\r\n  performSecurityChecks(sessionData, req) {\r\n    // IP address validation (optional, can be disabled for mobile networks)\r\n    if (sessionData.ip && sessionData.ip !== req.ip) {\r\n      // Allow some flexibility for mobile networks\r\n      const ipChanged = !this.isIPChangeAllowed(sessionData.ip, req.ip);\r\n      if (ipChanged) {\r\n        return { passed: false, reason: 'IP address mismatch' };\r\n      }\r\n    }\r\n\r\n    // User Agent validation\r\n    if (sessionData.userAgent && sessionData.userAgent !== req.get('User-Agent')) {\r\n      return { passed: false, reason: 'User agent mismatch' };\r\n    }\r\n\r\n    // Device fingerprint validation\r\n    const currentFingerprint = this.generateDeviceFingerprint(req);\r\n    if (sessionData.deviceFingerprint && sessionData.deviceFingerprint !== currentFingerprint) {\r\n      return { passed: false, reason: 'Device fingerprint mismatch' };\r\n    }\r\n\r\n    return { passed: true };\r\n  }\r\n\r\n  // Check if IP change is allowed (for mobile networks)\r\n  isIPChangeAllowed(oldIP, newIP) {\r\n    // Allow changes within same subnet or geographic region\r\n    // This is a simplified implementation\r\n    const oldParts = oldIP.split('.');\r\n    const newParts = newIP.split('.');\r\n    \r\n    // Allow changes if first two octets are the same (same subnet)\r\n    return oldParts.length === 4 && newParts.length === 4 && \r\n           oldParts[0] === newParts[0] && oldParts[1] === newParts[1];\r\n  }\r\n\r\n  // Refresh/extend session\r\n  async refreshSession(sessionId, req, options = {}) {\r\n    try {\r\n      const validation = await this.validateSession(sessionId, req);\r\n      if (!validation.valid) {\r\n        return { success: false, reason: validation.reason };\r\n      }\r\n\r\n      const session = validation.session;\r\n      const now = new Date();\r\n      const newExpiry = new Date(now.getTime() + (options.maxAge || 24 * 60 * 60 * 1000));\r\n\r\n      session.lastActivity = now;\r\n      session.expiresAt = newExpiry;\r\n\r\n      // Update in Redis\r\n      if (this.redis) {\r\n        const sessionKey = `session:${sessionId}`;\r\n        const ttl = Math.floor((newExpiry.getTime() - now.getTime()) / 1000);\r\n        await this.redis.setEx(sessionKey, ttl, JSON.stringify(session));\r\n      } else {\r\n        // Update in database\r\n        await this.prisma.userSession.update({\r\n          where: { token: sessionId },\r\n          data: { expiresAt: newExpiry }\r\n        });\r\n      }\r\n\r\n      this.logger.logSecurity('Session Refreshed', session.userId, {\r\n        sessionId,\r\n        ip: req.ip,\r\n        newExpiry: newExpiry.toISOString()\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        sessionId,\r\n        expiresAt: newExpiry,\r\n        maxAge: options.maxAge || 24 * 60 * 60 * 1000\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Session refresh error', error.message);\r\n      return { success: false, reason: 'Session refresh failed' };\r\n    }\r\n  }\r\n\r\n  // Destroy session\r\n  async destroySession(sessionId, reason = 'logout') {\r\n    try {\r\n      // Remove from Redis\r\n      if (this.redis) {\r\n        const sessionKey = `session:${sessionId}`;\r\n        const sessionString = await this.redis.get(sessionKey);\r\n        \r\n        if (sessionString) {\r\n          const sessionData = JSON.parse(sessionString);\r\n          const userSessionsKey = `user_sessions:${sessionData.userId}`;\r\n          \r\n          // Remove from user sessions index\r\n          await this.redis.zRem(userSessionsKey, sessionId);\r\n          await this.redis.del(sessionKey);\r\n          \r\n          this.logger.logSecurity('Session Destroyed', sessionData.userId, {\r\n            sessionId,\r\n            reason,\r\n            ip: sessionData.ip\r\n          });\r\n        }\r\n      } else {\r\n        // Remove from database\r\n        const session = await this.prisma.userSession.findUnique({\r\n          where: { token: sessionId }\r\n        });\r\n\r\n        if (session) {\r\n          await this.prisma.userSession.delete({\r\n            where: { id: session.id }\r\n          });\r\n          \r\n          this.logger.logSecurity('Session Destroyed', session.userId, {\r\n            sessionId,\r\n            reason\r\n          });\r\n        }\r\n      }\r\n\r\n      return { success: true };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Session destruction error', error.message);\r\n      return { success: false, reason: 'Session destruction failed' };\r\n    }\r\n  }\r\n\r\n  // Destroy all user sessions (except current)\r\n  async destroyAllUserSessions(userId, exceptSessionId = null) {\r\n    try {\r\n      let destroyedSessions = [];\r\n\r\n      if (this.redis) {\r\n        const userSessionsKey = `user_sessions:${userId}`;\r\n        const sessionIds = await this.redis.zRange(userSessionsKey, 0, -1);\r\n        \r\n        for (const sessionId of sessionIds) {\r\n          if (sessionId !== exceptSessionId) {\r\n            await this.destroySession(sessionId, 'mass_logout');\r\n            destroyedSessions.push(sessionId);\r\n          }\r\n        }\r\n      } else {\r\n        // Database fallback\r\n        const sessions = await this.prisma.userSession.findMany({\r\n          where: { \r\n            userId,\r\n            ...(exceptSessionId && { token: { not: exceptSessionId } })\r\n          }\r\n        });\r\n\r\n        for (const session of sessions) {\r\n          await this.destroySession(session.token, 'mass_logout');\r\n          destroyedSessions.push(session.token);\r\n        }\r\n      }\r\n\r\n      this.logger.logSecurity('All User Sessions Destroyed', userId, {\r\n        destroyedCount: destroyedSessions.length,\r\n        exceptSessionId\r\n      });\r\n\r\n      return { success: true, destroyedCount: destroyedSessions.length };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Mass session destruction error', error.message);\r\n      return { success: false, reason: 'Mass session destruction failed' };\r\n    }\r\n  }\r\n\r\n  // Get active sessions for user\r\n  async getUserSessions(userId) {\r\n    try {\r\n      let sessions = [];\r\n\r\n      if (this.redis) {\r\n        const userSessionsKey = `user_sessions:${userId}`;\r\n        const sessionIds = await this.redis.zRange(userSessionsKey, 0, -1);\r\n        \r\n        for (const sessionId of sessionIds) {\r\n          const sessionKey = `session:${sessionId}`;\r\n          const sessionString = await this.redis.get(sessionKey);\r\n          \r\n          if (sessionString) {\r\n            const sessionData = JSON.parse(sessionString);\r\n            if (sessionData.expiresAt > new Date()) {\r\n              sessions.push({\r\n                sessionId,\r\n                createdAt: sessionData.createdAt,\r\n                lastActivity: sessionData.lastActivity,\r\n                expiresAt: sessionData.expiresAt,\r\n                ip: sessionData.ip,\r\n                userAgent: sessionData.userAgent,\r\n                loginType: sessionData.loginType,\r\n                isActive: sessionData.isActive\r\n              });\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        // Database fallback\r\n        const dbSessions = await this.prisma.userSession.findMany({\r\n          where: { \r\n            userId,\r\n            expiresAt: { gt: new Date() }\r\n          },\r\n          orderBy: { createdAt: 'desc' }\r\n        });\r\n\r\n        sessions = dbSessions.map(session => ({\r\n          sessionId: session.token,\r\n          createdAt: session.createdAt,\r\n          expiresAt: session.expiresAt,\r\n          isActive: true\r\n        }));\r\n      }\r\n\r\n      return { success: true, sessions };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Get user sessions error', error.message);\r\n      return { success: false, reason: 'Failed to retrieve user sessions' };\r\n    }\r\n  }\r\n\r\n  // Cleanup expired sessions\r\n  async cleanupExpiredSessions() {\r\n    try {\r\n      let cleanedCount = 0;\r\n\r\n      if (this.redis) {\r\n        // Redis handles expiration automatically, but we can clean up user session indexes\r\n        const pattern = 'user_sessions:*';\r\n        const keys = await this.redis.keys(pattern);\r\n        \r\n        for (const key of keys) {\r\n          const sessionIds = await this.redis.zRange(key, 0, -1);\r\n          const validSessions = [];\r\n          \r\n          for (const sessionId of sessionIds) {\r\n            const sessionKey = `session:${sessionId}`;\r\n            const exists = await this.redis.exists(sessionKey);\r\n            if (exists) {\r\n              validSessions.push(sessionId);\r\n            }\r\n          }\r\n          \r\n          // Update user sessions index with only valid sessions\r\n          await this.redis.del(key);\r\n          if (validSessions.length > 0) {\r\n            await this.redis.zAdd(key, validSessions.map(id => ({ score: Date.now(), value: id })));\r\n          }\r\n          \r\n          cleanedCount += sessionIds.length - validSessions.length;\r\n        }\r\n      } else {\r\n        // Database cleanup\r\n        const result = await this.prisma.userSession.deleteMany({\r\n          where: { expiresAt: { lt: new Date() } }\r\n        });\r\n        cleanedCount = result.count;\r\n      }\r\n\r\n      this.logger.info('Session cleanup completed', {\r\n        cleanedCount,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      return { success: true, cleanedCount };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Session cleanup error', error.message);\r\n      return { success: false, reason: 'Session cleanup failed' };\r\n    }\r\n  }\r\n\r\n  // Get session statistics\r\n  async getSessionStats() {\r\n    try {\r\n      let stats = {\r\n        totalSessions: 0,\r\n        activeSessions: 0,\r\n        expiredSessions: 0,\r\n        redisAvailable: this.redis !== null\r\n      };\r\n\r\n      if (this.redis) {\r\n        const pattern = 'session:*';\r\n        const keys = await this.redis.keys(pattern);\r\n        stats.totalSessions = keys.length;\r\n        \r\n        const now = new Date();\r\n        for (const key of keys) {\r\n          const sessionString = await this.redis.get(key);\r\n          if (sessionString) {\r\n            const sessionData = JSON.parse(sessionString);\r\n            if (sessionData.expiresAt > now) {\r\n              stats.activeSessions++;\r\n            } else {\r\n              stats.expiredSessions++;\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        // Database stats\r\n        const [total, active] = await Promise.all([\r\n          this.prisma.userSession.count(),\r\n          this.prisma.userSession.count({\r\n            where: { expiresAt: { gt: new Date() } }\r\n          })\r\n        ]);\r\n        \r\n        stats.totalSessions = total;\r\n        stats.activeSessions = active;\r\n        stats.expiredSessions = total - active;\r\n      }\r\n\r\n      return { success: true, stats };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Session stats error', error.message);\r\n      return { success: false, reason: 'Failed to get session statistics' };\r\n    }\r\n  }\r\n\r\n  // Validate remember me token\r\n  async validateRememberMeToken(token) {\r\n    try {\r\n      if (!token) {\r\n        return { valid: false, reason: 'No remember me token provided' };\r\n      }\r\n\r\n      // Try Redis first\r\n      if (this.redis) {\r\n        const tokenKey = `remember_me:${token}`;\r\n        const tokenString = await this.redis.get(tokenKey);\r\n        \r\n        if (tokenString) {\r\n          const tokenData = JSON.parse(tokenString);\r\n          \r\n          // Check if token has expired\r\n          if (tokenData.expiresAt && new Date() > tokenData.expiresAt) {\r\n            await this.redis.del(tokenKey);\r\n            return { valid: false, reason: 'Remember me token expired' };\r\n          }\r\n          \r\n          return {\r\n            valid: true,\r\n            userId: tokenData.userId,\r\n            deviceFingerprint: tokenData.deviceFingerprint,\r\n            createdAt: tokenData.createdAt\r\n          };\r\n        }\r\n      } else {\r\n        // Database fallback for remember me tokens\r\n        const rememberMeToken = await this.prisma.rememberMeToken.findUnique({\r\n          where: { token },\r\n          include: { user: true }\r\n        });\r\n\r\n        if (!rememberMeToken || rememberMeToken.expiresAt < new Date()) {\r\n          return { valid: false, reason: 'Remember me token not found or expired' };\r\n        }\r\n\r\n        return {\r\n          valid: true,\r\n          userId: rememberMeToken.userId,\r\n          deviceFingerprint: rememberMeToken.deviceFingerprint,\r\n          createdAt: rememberMeToken.createdAt\r\n        };\r\n      }\r\n\r\n    } catch (error) {\r\n      this.logger.error('Remember me token validation error', error.message);\r\n      return { valid: false, reason: 'Token validation failed' };\r\n    }\r\n  }\r\n\r\n  // Create remember me token\r\n  async createRememberMeToken(userId, req) {\r\n    try {\r\n      const token = this.generateSessionId(); // Use same secure generation\r\n      const deviceFingerprint = this.generateDeviceFingerprint(req);\r\n      const now = new Date();\r\n      const expiresAt = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days\r\n\r\n      const tokenData = {\r\n        userId,\r\n        token,\r\n        deviceFingerprint,\r\n        createdAt: now,\r\n        expiresAt,\r\n        isActive: true\r\n      };\r\n\r\n      // Store in Redis if available\r\n      if (this.redis) {\r\n        const tokenKey = `remember_me:${token}`;\r\n        const ttl = Math.floor((expiresAt.getTime() - now.getTime()) / 1000);\r\n        await this.redis.setEx(tokenKey, ttl, JSON.stringify(tokenData));\r\n        \r\n        // Also store user remember me tokens index\r\n        const userTokensKey = `user_remember_me:${userId}`;\r\n        await this.redis.zAdd(userTokensKey, [{\r\n          score: now.getTime(),\r\n          value: token\r\n        }]);\r\n        await this.redis.expire(userTokensKey, 30 * 24 * 60 * 60); // 30 days\r\n      } else {\r\n        // Database fallback - would need to create rememberMeToken table\r\n        this.logger.warn('Remember me tokens require Redis for full functionality');\r\n      }\r\n\r\n      this.logger.logSecurity('Remember Me Token Created', userId, {\r\n        token,\r\n        deviceFingerprint,\r\n        expiresAt: expiresAt.toISOString(),\r\n        ip: req.ip\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        token,\r\n        expiresAt\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Failed to create remember me token', error.message);\r\n      return { success: false, reason: 'Token creation failed' };\r\n    }\r\n  }\r\n\r\n  // Refresh session using remember me token\r\n  async refreshFromRememberMeToken(token, req) {\r\n    try {\r\n      const validation = await this.validateRememberMeToken(token);\r\n      \r\n      if (!validation.valid) {\r\n        return { success: false, reason: validation.reason };\r\n      }\r\n\r\n      // Verify device fingerprint matches\r\n      const currentFingerprint = this.generateDeviceFingerprint(req);\r\n      if (validation.deviceFingerprint !== currentFingerprint) {\r\n        this.logger.logSecurity('Remember Me Device Mismatch', validation.userId, {\r\n          token,\r\n          expectedFingerprint: validation.deviceFingerprint,\r\n          actualFingerprint: currentFingerprint,\r\n          ip: req.ip\r\n        });\r\n        return { success: false, reason: 'Device fingerprint mismatch' };\r\n      }\r\n\r\n      // Create new session\r\n      const sessionResult = await this.createSession(validation.userId, req, {\r\n        loginType: 'remember_me',\r\n        rememberMe: true,\r\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days for remembered sessions\r\n        securityLevel: 'standard'\r\n      });\r\n\r\n      if (!sessionResult.sessionId) {\r\n        return { success: false, reason: 'Failed to create session from remember me token' };\r\n      }\r\n\r\n      // Clean up old remember me token for security\r\n      if (this.redis) {\r\n        const tokenKey = `remember_me:${token}`;\r\n        await this.redis.del(tokenKey);\r\n      }\r\n\r\n      this.logger.logSecurity('Session Refreshed from Remember Me', validation.userId, {\r\n        newSessionId: sessionResult.sessionId,\r\n        ip: req.ip,\r\n        userAgent: req.get('User-Agent')\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        sessionId: sessionResult.sessionId,\r\n        expiresAt: sessionResult.expiresAt,\r\n        maxAge: sessionResult.maxAge,\r\n        userId: validation.userId\r\n      };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Remember me session refresh error', error.message);\r\n      return { success: false, reason: 'Session refresh failed' };\r\n    }\r\n  }\r\n\r\n  // Clean up expired remember me tokens\r\n  async cleanupExpiredRememberMeTokens() {\r\n    try {\r\n      let cleanedCount = 0;\r\n\r\n      if (this.redis) {\r\n        const pattern = 'remember_me:*';\r\n        const keys = await this.redis.keys(pattern);\r\n        \r\n        for (const key of keys) {\r\n          const tokenString = await this.redis.get(key);\r\n          if (tokenString) {\r\n            const tokenData = JSON.parse(tokenString);\r\n            if (tokenData.expiresAt && new Date() > tokenData.expiresAt) {\r\n              await this.redis.del(key);\r\n              cleanedCount++;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      this.logger.info('Remember me token cleanup completed', {\r\n        cleanedCount,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n\r\n      return { success: true, cleanedCount };\r\n\r\n    } catch (error) {\r\n      this.logger.error('Remember me token cleanup error', error.message);\r\n      return { success: false, reason: 'Cleanup failed' };\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nconst sessionService = new SessionService();\r\n\r\nmodule.exports = {\r\n  SessionService,\r\n  sessionService\r\n};"],"mappings":"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","ignoreList":[]}