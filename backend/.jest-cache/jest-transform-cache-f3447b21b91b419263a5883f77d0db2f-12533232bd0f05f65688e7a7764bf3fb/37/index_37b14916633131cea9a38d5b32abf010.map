{"version":3,"names":["express","require","cors","helmet","morgan","config","databaseService","configService","loggerService","authMiddleware","swaggerService","authRoutes","userRoutes","productRoutes","categoryRoutes","brandRoutes","orderRoutes","cartRoutes","wishlistRoutes","reviewRoutes","couponRoutes","routeIndex","app","PORT","get","use","corsConfig","getCORSConfig","allowedOrigins","process","env","NODE_ENV","origin","callback","indexOf","Error","credentials","methods","allowedHeaders","exposedHeaders","optionsSuccessStatus","stream","json","urlencoded","extended","requestId","optional","rateLimit","req","res","message","version","status","database","services","getClient","logger","healthStatus","healthCheck","timestamp","Date","toISOString","environment","error","stats","getStats","statistics","swaggerSpec","generateSwaggerSpec","setHeader","send","errorLogger","path","originalUrl","on","info","signal","disconnect","cleanup","exit","listen","port","connect","module","exports"],"sources":["index.js"],"sourcesContent":["const express = require('express');\r\nconst cors = require('cors');\r\nconst helmet = require('helmet');\r\nconst morgan = require('morgan');\r\nrequire('dotenv').config();\r\n\r\n// Import services\r\nconst { databaseService } = require('./services/database');\r\nconst { configService } = require('./services/config');\r\nconst { loggerService } = require('./services/logger');\r\nconst { authMiddleware } = require('./middleware/auth');\r\nconst { swaggerService } = require('./swagger');\r\n\r\n// Import routes\r\nconst authRoutes = require('./routes/auth');\r\nconst userRoutes = require('./routes/users');\r\nconst productRoutes = require('./routes/products');\r\nconst categoryRoutes = require('./routes/categories');\r\nconst brandRoutes = require('./routes/brands');\r\nconst orderRoutes = require('./routes/orders');\r\nconst cartRoutes = require('./routes/cart');\r\nconst wishlistRoutes = require('./routes/wishlist');\r\nconst reviewRoutes = require('./routes/reviews');\r\nconst couponRoutes = require('./routes/coupons');\r\nconst routeIndex = require('./routes/index');\r\n\r\nconst app = express();\r\nconst PORT = configService.get('PORT');\r\n\r\n// Middleware\r\napp.use(helmet());\r\n\r\n// Enhanced CORS configuration with strict origin validation\r\nconst corsConfig = configService.getCORSConfig();\r\nconst allowedOrigins = process.env.NODE_ENV === 'production'\r\n  ? [\r\n      'https://smarttechnologies-bd.com',\r\n      'https://www.smarttechnologies-bd.com',\r\n      'https://admin.smarttechnologies-bd.com'\r\n    ]\r\n  : process.env.NODE_ENV === 'staging'\r\n  ? [\r\n      'https://staging.smarttechnologies-bd.com',\r\n      'https://admin-staging.smarttechnologies-bd.com'\r\n    ]\r\n  : [\r\n      'http://localhost:3000',\r\n      'http://localhost:3001',\r\n      'http://127.0.0.1:3000',\r\n      'http://127.0.0.1:3001'\r\n    ];\r\n\r\napp.use(cors({\r\n  origin: function (origin, callback) {\r\n    // Allow requests with no origin (like mobile apps or curl requests)\r\n    if (!origin) return callback(null, true);\r\n    \r\n    if (allowedOrigins.indexOf(origin) !== -1) {\r\n      callback(null, true);\r\n    } else {\r\n      callback(new Error('Not allowed by CORS'));\r\n    }\r\n  },\r\n  credentials: corsConfig.credentials,\r\n  methods: corsConfig.methods,\r\n  allowedHeaders: corsConfig.allowedHeaders,\r\n  exposedHeaders: corsConfig.exposedHeaders,\r\n  optionsSuccessStatus: 200\r\n}));\r\n\r\napp.use(morgan('combined', { stream: loggerService.stream() }));\r\napp.use(express.json());\r\napp.use(express.urlencoded({ extended: true }));\r\n\r\n// Request ID middleware\r\napp.use(authMiddleware.requestId());\r\n\r\n// Authentication middleware (optional)\r\napp.use('/api/v1/auth', authMiddleware.optional());\r\n\r\n// Rate limiting\r\napp.use(authMiddleware.rateLimit());\r\n\r\n// API routes\r\napp.use('/api', routeIndex);\r\n\r\n// Basic route\r\napp.get('/', (req, res) => {\r\n  res.json({\r\n    message: 'Smart Technologies Bangladesh B2C Website Backend API',\r\n    version: '1.0.0',\r\n    status: 'running',\r\n    database: 'connected',\r\n    services: {\r\n      database: databaseService.getClient() ? 'connected' : 'disconnected',\r\n      config: 'loaded',\r\n      logger: 'active'\r\n    }\r\n  });\r\n});\r\n\r\n// Health check endpoint with database connection\r\napp.get('/health', async (req, res) => {\r\n  try {\r\n    const healthStatus = await databaseService.healthCheck();\r\n    \r\n    res.status(200).json({\r\n      status: 'OK',\r\n      timestamp: new Date().toISOString(),\r\n      database: healthStatus.database,\r\n      environment: configService.get('NODE_ENV')\r\n    });\r\n  } catch (error) {\r\n    loggerService.error('Health check failed', error);\r\n    res.status(503).json({\r\n      status: 'ERROR',\r\n      timestamp: new Date().toISOString(),\r\n      database: 'disconnected',\r\n      error: 'Database connection failed'\r\n    });\r\n  }\r\n});\r\n\r\n// Database status endpoint\r\napp.get('/api/db-status', async (req, res) => {\r\n  try {\r\n    const stats = await databaseService.getStats();\r\n    \r\n    res.status(200).json({\r\n      status: 'connected',\r\n      statistics: stats,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    loggerService.error('Database status check failed', error);\r\n    res.status(500).json({\r\n      status: 'error',\r\n      error: 'Failed to retrieve database statistics',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n});\r\n\r\n// Swagger documentation endpoint\r\napp.get('/api-docs', (req, res) => {\r\n  try {\r\n    const swaggerSpec = swaggerService.generateSwaggerSpec();\r\n    \r\n    res.setHeader('Content-Type', 'application/json');\r\n    res.send(swaggerSpec);\r\n  } catch (error) {\r\n    loggerService.error('Failed to generate Swagger docs', error);\r\n    res.status(500).json({\r\n      error: 'Failed to generate API documentation',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n});\r\n\r\n// Error handling middleware\r\nconst { errorLogger } = require('./middleware/auth');\r\napp.use(errorLogger());\r\n\r\n// 404 handler\r\napp.use((req, res) => {\r\n  res.status(404).json({\r\n    error: 'Route not found',\r\n    path: req.originalUrl,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on('SIGINT', async () => {\r\n  loggerService.info('Server shutdown initiated', { signal: 'SIGINT' });\r\n  await databaseService.disconnect();\r\n  loggerService.cleanup();\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGTERM', async () => {\r\n  loggerService.info('Server shutdown initiated', { signal: 'SIGTERM' });\r\n  await databaseService.disconnect();\r\n  loggerService.cleanup();\r\n  process.exit(0);\r\n});\r\n\r\n// Start server\r\napp.listen(PORT, '0.0.0.0', async () => {\r\n  loggerService.info('Server started', {\r\n    port: PORT,\r\n    environment: configService.get('NODE_ENV'),\r\n    database: 'configured',\r\n    timestamp: new Date().toISOString()\r\n  });\r\n  \r\n  // Test database connection on startup\r\n  try {\r\n    await databaseService.connect();\r\n    loggerService.info('Database connection established successfully');\r\n  } catch (error) {\r\n    loggerService.error('Database connection failed on startup', error);\r\n  }\r\n});\r\n\r\nmodule.exports = { app };"],"mappings":"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","ignoreList":[]}